/* ========================================
 *
 * Copyright YOUR COMPANY, THE YEAR
 * All Rights Reserved
 * UNPUBLISHED, LICENSED SOFTWARE.
 *
 * CONFIDENTIAL AND PROPRIETARY INFORMATION
 * WHICH IS THE PROPERTY OF your company.
 *
 * ========================================
*/
#include "meter.h"
#include "project.h"

#define SCALE_SIZE  (256)

power32b16 Power2000Scale[SCALE_SIZE] = 
{
    0,
    112993,
    225986,
    338979,
    451972,
    564966,
    677959,
    790952,
    903945,
    1016938,
    1129931,
    1242924,
    1355917,
    1468910,
    1581903,
    1694897,
    1807890,
    1920883,
    2033876,
    2146869,
    2259862,
    2372855,
    2485848,
    2598841,
    2711834,
    2824828,
    2937821,
    3050814,
    3163807,
    3276800,
    3389793,
    3502786,
    3615779,
    3728772,
    3841766,
    3954759,
    4067752,
    4180745,
    4293738,
    4406731,
    4519724,
    4632717,
    4745710,
    4858703,
    4971697,
    5084690,
    5197683,
    5310676,
    5423669,
    5536662,
    5649655,
    5762648,
    5875641,
    5988634,
    6101628,
    6214621,
    6327614,
    6440607,
    6553600,
    7021714,
    7489829,
    7957943,
    8426057,
    8894171,
    9362286,
    9830400,
    10298514,
    10766629,
    11234743,
    11702857,
    12170971,
    12639086,
    13107200,
    13492706,
    13878212,
    14263718,
    14649224,
    15034729,
    15420235,
    15805741,
    16191247,
    16576753,
    16962259,
    17347765,
    17733271,
    18118776,
    18504282,
    18889788,
    19275294,
    19660800,
    20128914,
    20597029,
    21065143,
    21533257,
    22001371,
    22469486,
    22937600,
    23405714,
    23873829,
    24341943,
    24810057,
    25278171,
    25746286,
    26214400,
    26651307,
    27088213,
    27525120,
    27962027,
    28398933,
    28835840,
    29272747,
    29709653,
    30146560,
    30583467,
    31020373,
    31457280,
    31894187,
    32331093,
    32768000,
    33423360,
    34078720,
    34734080,
    35389440,
    36044800,
    36700160,
    37355520,
    38010880,
    38666240,
    39321600,
    40140800,
    40960000,
    41779200,
    42598400,
    43417600,
    44236800,
    45056000,
    45875200,
    46530560,
    47185920,
    47841280,
    48496640,
    49152000,
    49807360,
    50462720,
    51118080,
    51773440,
    52428800,
    53156978,
    53885156,
    54613333,
    55341511,
    56069689,
    56797867,
    57526044,
    58254222,
    58982400,
    59637760,
    60293120,
    60948480,
    61603840,
    62259200,
    62914560,
    63569920,
    64225280,
    64880640,
    65536000,
    66355200,
    67174400,
    67993600,
    68812800,
    69632000,
    70451200,
    71270400,
    72089600,
    73181867,
    74274133,
    75366400,
    76458667,
    77550933,
    78643200,
    79462400,
    80281600,
    81100800,
    81920000,
    82739200,
    83558400,
    84377600,
    85196800,
    86016000,
    86835200,
    87654400,
    88473600,
    89292800,
    90112000,
    90931200,
    91750400,
    92686629,
    93622857,
    94559086,
    95495314,
    96431543,
    97367771,
    98304000,
    99942400,
    101580800,
    103219200,
    104857600,
    106496000,
    108134400,
    109772800,
    111411200,
    113049600,
    114688000,
    116326400,
    117964800,
    119603200,
    121241600,
    122880000,
    124518400,
    126156800,
    127795200,
    129433600,
    131072000,
    132710400,
    134348800,
    135987200,
    137625600,
    139264000,
    140902400,
    142540800,
    144179200,
    145817600,
    147456000,
    149094400,
    150732800,
    152371200,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
};
power32b16 Power200Scale[SCALE_SIZE] = 
{
    0,
    13653,
    27307,
    40960,
    54613,
    68267,
    81920,
    95573,
    109227,
    122880,
    136533,
    150187,
    163840,
    177493,
    191147,
    204800,
    218453,
    232107,
    245760,
    259413,
    273067,
    286720,
    300373,
    314027,
    327680,
    341333,
    354987,
    368640,
    382293,
    395947,
    409600,
    423253,
    436907,
    450560,
    464213,
    477867,
    491520,
    505173,
    518827,
    532480,
    546133,
    559787,
    573440,
    587093,
    600747,
    614400,
    628053,
    641707,
    655360,
    688128,
    720896,
    753664,
    786432,
    819200,
    851968,
    884736,
    917504,
    950272,
    983040,
    1012829,
    1042618,
    1072407,
    1102196,
    1131985,
    1161775,
    1191564,
    1221353,
    1251142,
    1280931,
    1310720,
    1343488,
    1376256,
    1409024,
    1441792,
    1474560,
    1507328,
    1540096,
    1572864,
    1605632,
    1638400,
    1693013,
    1747627,
    1802240,
    1856853,
    1911467,
    1966080,
    2020693,
    2075307,
    2129920,
    2184533,
    2239147,
    2293760,
    2359296,
    2424832,
    2490368,
    2555904,
    2621440,
    2676053,
    2730667,
    2785280,
    2839893,
    2894507,
    2949120,
    3014656,
    3080192,
    3145728,
    3211264,
    3276800,
    3331413,
    3386027,
    3440640,
    3495253,
    3549867,
    3604480,
    3686400,
    3768320,
    3850240,
    3932160,
    3986773,
    4041387,
    4096000,
    4150613,
    4205227,
    4259840,
    4325376,
    4390912,
    4456448,
    4521984,
    4587520,
    4653056,
    4718592,
    4784128,
    4849664,
    4915200,
    4997120,
    5079040,
    5160960,
    5242880,
    5308416,
    5373952,
    5439488,
    5505024,
    5570560,
    5652480,
    5734400,
    5816320,
    5898240,
    5963776,
    6029312,
    6094848,
    6160384,
    6225920,
    6307840,
    6389760,
    6471680,
    6553600,
    6631619,
    6709638,
    6787657,
    6865676,
    6943695,
    7021714,
    7099733,
    7177752,
    7255771,
    7333790,
    7411810,
    7489829,
    7567848,
    7645867,
    7723886,
    7801905,
    7879924,
    7957943,
    8035962,
    8113981,
    8192000,
    8288376,
    8384753,
    8481129,
    8577506,
    8673882,
    8770259,
    8866635,
    8963012,
    9059388,
    9155765,
    9252141,
    9348518,
    9444894,
    9541271,
    9637647,
    9734024,
    9830400,
    9932800,
    10035200,
    10137600,
    10240000,
    10342400,
    10444800,
    10547200,
    10649600,
    10752000,
    10854400,
    10956800,
    11059200,
    11161600,
    11264000,
    11366400,
    11468800,
    11594831,
    11720862,
    11846892,
    11972923,
    12098954,
    12224985,
    12351015,
    12477046,
    12603077,
    12729108,
    12855138,
    12981169,
    13107200,
    13233231,
    13359262,
    13485292,
    13611323,
    13737354,
    13863385,
    13989415,
    14115446,
    14241477,
    14367508,
    14493538,
    14619569,
    14745600,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,

};
swr32b16 SWRScale[SCALE_SIZE] = 
{
    65536,
    66355,
    67174,
    67994,
    68813,
    69632,
    70451,
    71270,
    72090,
    72909,
    73728,
    74547,
    75366,
    76186,
    77005,
    77824,
    78643,
    79579,
    80516,
    81452,
    82388,
    83324,
    84261,
    85197,
    86289,
    87381,
    88474,
    89566,
    90658,
    91750,
    92687,
    93623,
    94559,
    95495,
    96432,
    97368,
    98304,
    99615,
    100925,
    102236,
    103547,
    104858,
    106168,
    107479,
    108790,
    110100,
    111411,
    112722,
    114033,
    115343,
    116654,
    117965,
    119057,
    120149,
    121242,
    122334,
    123426,
    124518,
    125829,
    127140,
    128451,
    129761,
    131072,
    132383,
    133693,
    135004,
    136315,
    137626,
    138936,
    140247,
    141558,
    142868,
    144179,
    145490,
    146801,
    148111,
    149422,
    150733,
    152044,
    153354,
    154665,
    155976,
    157286,
    158478,
    159670,
    160861,
    162053,
    163244,
    164436,
    165627,
    166819,
    168010,
    169202,
    170394,
    171704,
    173015,
    174326,
    175636,
    176947,
    178258,
    179569,
    180879,
    182190,
    183501,
    184812,
    186122,
    187433,
    188744,
    190054,
    191365,
    192676,
    193987,
    195297,
    196608,
    197871,
    199133,
    200396,
    201658,
    202921,
    204184,
    205446,
    206709,
    207972,
    209234,
    210497,
    211759,
    213022,
    214285,
    215547,
    216810,
    218073,
    219335,
    220598,
    221860,
    223123,
    224386,
    225648,
    226911,
    228174,
    229436,
    230699,
    231961,
    233224,
    234487,
    235749,
    237012,
    238274,
    239537,
    240800,
    242062,
    243325,
    244588,
    245850,
    247113,
    248375,
    249638,
    250901,
    252163,
    253426,
    254689,
    255951,
    257214,
    258476,
    259739,
    261002,
    262264,
    263527,
    264789,
    266052,
    267315,
    268577,
    269840,
    271103,
    272365,
    273628,
    274890,
    276153,
    277416,
    278678,
    279941,
    281204,
    282466,
    283729,
    284991,
    286254,
    287517,
    288779,
    290042,
    291305,
    292567,
    293830,
    295092,
    296355,
    297618,
    298880,
    300143,
    301405,
    302668,
    303931,
    305193,
    306456,
    307719,
    308981,
    310244,
    311506,
    312769,
    314032,
    315294,
    316557,
    317820,
    319082,
    320345,
    321607,
    322870,
    324133,
    325395,
    326658,
    327920,
    329183,
    330446,
    331708,
    332971,
    334234,
    335496,
    336759,
    338021,
    339284,
    340547,
    341809,
    343072,
    344335,
    345597,
    346860,
    348122,
    349385,
    350648, 
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,
    2147483647,

};

void SetMeterOutput(int input, int outputScale[])
{
    int idx = 0;
    if(input <= outputScale[0])
    {
        idx = 0;
    }
    else if(input >= outputScale[SCALE_SIZE-1])
    {
        idx = SCALE_SIZE - 1;
    }
    else
    {
        // Perform binary search through output scale to find output value.
        idx = SCALE_SIZE/2;
        int jumpSize = SCALE_SIZE/4;
        while(!((outputScale[idx] <= input) && (input < outputScale[idx+1])) )
        {
            // continue search
            if(outputScale[idx] <= input)
            {
                idx += jumpSize;
            }
            else
            {
                idx -= jumpSize;
            }
            
            if(jumpSize >= 2)
            {
                jumpSize /= 2;
            }       
        }
    }
    
    IDAC8_SetValue(idx);
}

void Meter_SetPower200(power32b16 power)
{
    SetMeterOutput(power, Power200Scale);    
}

void Meter_SetPower2000(power32b16 power)
{
    SetMeterOutput(power, Power2000Scale);
}

void Meter_SetSWR(swr32b16 swr)
{
    SetMeterOutput(swr, SWRScale);
}

/* [] END OF FILE */
